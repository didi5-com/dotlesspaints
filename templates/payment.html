{% extends "base.html" %}

{% block title %}Payment - Dotless Paint{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <h2 class="fw-bold">Complete Your Payment</h2>
                <p class="text-muted">Order #{{ order.id }}</p>
            </div>

            <div class="card shadow">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3">Order Summary</h5>
                            <div class="order-summary">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Total Amount</span>
                                    <span class="fw-bold">₦{{ "{:,.0f}".format(order.total_amount) }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Shipping</span>
                                    <span class="text-success">Free</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Total</h6>
                                    <h6 class="fw-bold">₦{{ "{:,.0f}".format(order.total_amount) }}</h6>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3">Payment Method: {{ order.payment_method.name }}</h5>

                            {% if order.payment_method.method_type == 'gateway' %}
                                <!-- Paystack Payment -->
                                <div class="text-center">
                                    <button type="button" id="paystack-btn" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-credit-card"></i> Pay with Card
                                    </button>
                                </div>

                                <div class="payment-methods mt-3">
                                    <small class="text-muted">Accepted payment methods:</small>
                                    <div class="payment-icons mt-2">
                                        <i class="fab fa-cc-visa fa-2x text-primary me-2"></i>
                                        <i class="fab fa-cc-mastercard fa-2x text-warning me-2"></i>
                                        <i class="fas fa-university fa-2x text-info me-2"></i>
                                        <i class="fas fa-mobile-alt fa-2x text-success"></i>
                                    </div>
                                </div>

                            {% elif order.payment_method.method_type == 'manual' %}
                                <!-- Bank Transfer -->
                                {% set config = order.payment_method.configuration | from_json %}
                                <div class="bank-details bg-light p-3 rounded">
                                    <h6 class="fw-bold">Bank Transfer Details</h6>
                                    <div class="mb-2">
                                        <strong>Account Name:</strong> {{ config.account_name }}
                                    </div>
                                    <div class="mb-2">
                                        <strong>Account Number:</strong> {{ config.account_number }}
                                    </div>
                                    <div class="mb-2">
                                        <strong>Bank:</strong> {{ config.bank_name }}
                                    </div>
                                    <div class="mb-2">
                                        <strong>Amount:</strong> ₦{{ "{:,.0f}".format(order.total_amount) }}
                                    </div>
                                    <p class="mt-3 text-muted">
                                        Please transfer the exact amount to the account details above and then click the button below to confirm payment.
                                    </p>
                                    <div class="text-center mt-3">
                                        <button type="button" onclick="confirmManualPayment({{ order.id }})" class="btn btn-success btn-lg w-100">
                                            <i class="fas fa-check"></i> Confirm Bank Transfer
                                        </button>
                                    </div>
                                </div>

                            {% elif order.payment_method.method_type == 'crypto' %}
                                <!-- Cryptocurrency Payment -->
                                {% set config = order.payment_method.configuration | from_json %}
                                <div class="crypto-details bg-light p-3 rounded">
                                    <h6 class="fw-bold">Cryptocurrency Payment</h6>
                                    {% if config.btc_address %}
                                        <div class="mb-2">
                                            <strong>Bitcoin Address:</strong> 
                                            <code class="text-break">{{ config.btc_address }}</code>
                                        </div>
                                    {% endif %}
                                    {% if config.eth_address %}
                                        <div class="mb-2">
                                            <strong>Ethereum Address:</strong> 
                                            <code class="text-break">{{ config.eth_address }}</code>
                                        </div>
                                    {% endif %}
                                    <div class="mb-2">
                                        <strong>Amount:</strong> ₦{{ "{:,.0f}".format(order.total_amount) }}
                                    </div>
                                    <p class="mt-3 text-muted">
                                        Send the equivalent cryptocurrency amount to the address above and then click the button below to confirm payment.
                                    </p>
                                    <div class="text-center mt-3">
                                        <button type="button" onclick="confirmCryptoPayment({{ order.id }})" class="btn btn-warning btn-lg w-100">
                                            <i class="fab fa-bitcoin"></i> Confirm Crypto Payment
                                        </button>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="security-info mt-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-lock text-success me-2"></i>
                                    <small class="text-muted">Your payment information is secure and encrypted</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if order.payment_method.method_type == 'gateway' %}
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
document.getElementById('paystack-btn').addEventListener('click', function() {
    var handler = PaystackPop.setup({
        key: '{{ paystack_public_key }}',
        email: '{{ current_user.email }}',
        amount: {{ order.total_amount * 100 }}, // Amount in kobo
        currency: 'NGN',
        ref: 'order_{{ order.id }}_' + Math.floor((Math.random() * 1000000000) + 1),
        callback: function(response) {
            window.location.href = '/verify_payment/{{ order.id }}?reference=' + response.reference;
        },
        onClose: function() {
            alert('Payment was cancelled');
        }
    });
    handler.openIframe();
});
</script>
{% endif %}

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('Wallet address copied to clipboard!');
    });
}

function confirmManualPayment(orderId) {
    if (confirm('Have you completed the bank transfer? This will mark your payment as pending verification.')) {
        fetch('/confirm_manual_payment/' + orderId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Payment confirmation received! We will verify and update your order status.');
                  window.location.href = '/order/' + orderId;
              } else {
                  alert('Error processing confirmation. Please try again.');
              }
          });
    }
}

function confirmCryptoPayment(orderId) {
    if (confirm('Have you sent the cryptocurrency payment? This will mark your payment as pending verification.')) {
        fetch('/confirm_crypto_payment/' + orderId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Crypto payment confirmation received! We will verify and update your order status.');
                  window.location.href = '/order/' + orderId;
              } else {
                  alert('Error processing confirmation. Please try again.');
              }
          });
    }
}
</script>
{% endblock %}